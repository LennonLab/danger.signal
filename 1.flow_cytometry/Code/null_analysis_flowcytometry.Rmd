---
title: "D.S. flow cytometry analysis for Magalie"
author: "Joy O'Brien"
date: "2025-05-06"
output: html_document
---
Goal: Create figures that show null results for danger signals for Magalie et al from Daniel Schwartz's flow cytometry data (obtained from flow-spore-time repo)
```{r setup, include=FALSE}
setwd("~/GitHub/danger.signal/1.flow_cytometry")
```

1. Load data
```{r}
flow.spore <- read.csv("~/GitHub/danger.signal/1.flow_cytometry/Data/clean_counts.csv")
```

2. Set up data to create figure of % spores and time
```{r}
library(ggplot2)
# Subset the data 
ggplot(flow.spore, aes(x = time.hr, y = spore.ml, color = trt)) +
  #geom_line() +
  geom_smooth(span = 0.4, alpha = 0.2) +
  #geom_smooth(span, se = TRUE, alpha = 0.2) +
  #geom_point() +
  labs(
    title = "",
    x = "Time (hours)",
    y = "Spores per mL",
    color = "Treatment"
  ) +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 1),
    legend.position = "right",  # adjust legend position
    theme_minimal()
  )





```
Growth curve analysis gcplyr (Gompertz)
```{r}
# Removing some columns we don't need 
# Rename some columns 
fc.buffer.gc <- fc.buffer %>%
  select(-sample.date, -exp.plate, -t.exp, -veg.ml, -cell.ml, -trt)

#install.packages("gcplyr")
library(gcplyr)

fc.buffer.fits <- MinMaxGC(
  data = fc.buffer.gc,
  time_col = "time.hr",
  data_col = "spore.ml",
  sample_col = "bio.rep",
  model = "gompertz"
)

```




2A.Repeated measures Anova

```{r}
aov_result <- aov(spore.ml ~ trt * time.hr + Error(bio.rep/time.hr), data = flow.spore)
summary(aov_result)


```
Given the outputs of the Rm-ANOVA we know: 
- spore count changes significantly over time regardless of treatment (expected)
- there is no statistically significant in spore yield due to treatment (null result)
- there is a statistically significant treatment and time interaction




Figure that includes RM-ANOVA p-value
```{r}
ggplot(flow.spore, aes(x = time.hr, y = spore.ml, color = trt)) +
  #geom_point() +
  geom_smooth(span = 0.4, alpha = 0.2) + 
  labs(
    title = "",
    x = "Time (hours)",
    y = "Spores per mL",
    color = "Treatment"
  ) +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 1),
    legend.position = "right",  # adjust legend position
    panel.grid.major = element_blank(),  # removes major grid lines
    panel.grid.minor = element_blank(),  # removes minor grid lines
    panel.background = element_blank(),  # removes the background color
    plot.background = element_blank(),  # removes background around the plot
    theme_minimal()  # minimal theme
  ) +
  annotate("text", x = 20, y = 1500000000, label = "Rm-ANOVA p = 0.064", color = "black", size = 5)
```

3. Set up data to estimate onset of sporulation (lag time) via Gompertz
```{r setup}
rm(list=ls())
setwd("~/GitHub/danger.signal/1.flow_cytometry/GrowthCurves")
knitr::opts_knit$set(root.dir = "~/GitHub/danger.signal/1.flow_cytometry/GrowthCurves")
```


```{r}
# Load packages and functions
require("png")
require("dplyr")
require("grid")
require("gtools")
require("nlme")
require("MuMIn")
require("bbmle")
source("~/GitHub/danger.signal/1.flow_cytometry/GrowthCurves/bin/modified_Gomp_diagnostic3.R")
sem <- function(x) sqrt(var(x)/length(x))
cv <- function(x) 100*( sd(x)/mean(x))
```

3A. Load data
```{r}
flow.spore <- read.csv("~/GitHub/danger.signal/1.flow_cytometry/Data/clean_counts.csv")

# Change time to numeric 

```

Group samples by treatment
```{r}
fc.buffer <- flow.spore %>%
  filter(trt %in% c("BUFFER"))

# Separate out by experimental plate too?
fc.buffer.exp1 <- fc.buffer %>%
  filter(exp.plate == "plt1")

fc.buffer.exp2 <- fc.buffer %>%
  filter(exp.plate == "plt2")

# Transfer to wide format so we can run the model
library(tidyr)

fc.buffer.wide.exp1 <- fc.buffer.exp1 %>%
  pivot_wider(names_from = bio.rep, values_from = spore.ml)


# Rename some columns 
fc.buffer.wide.exp1 <- fc.buffer.wide.exp1 %>%
  rename(Time = time.hr)

# Average across biological replicates?

# Rename the sample names so we know the treatment
fc.buffer.wide.exp1 <- fc.buffer.wide.exp1 %>%
  rename(buffer_br1 = br1)

fc.buffer.wide.exp1 <- fc.buffer.wide.exp1 %>%
  rename(buffer_br2 = br2)

fc.buffer.wide.exp1 <- fc.buffer.wide.exp1 %>%
  rename(buffer_br3 = br3)

# Remove unneeded data
fc.buffer.wide.exp.1.min <- fc.buffer.wide.exp1 %>%
  select(-sample.date, -exp.plate, -t.exp, -veg.ml, -cell.ml, -trt)

# Collapse multiple rows per time point via dplyr
fc.buffer.wide.clean.exp1 <- fc.buffer.wide.exp.1.min %>%
  group_by(Time) %>%
  summarise(across(everything(), ~ first(na.omit(.))), .groups = "drop")

# Remove samples without any variation (Check to see if this is causing the error below)
fc.buffer.wide.clean.exp1 <- fc.buffer.wide.clean.exp1 %>%
  select(Time, where(~ sd(., na.rm = TRUE) > 0))

```


```{r}
fc.DSM <- flow.spore %>%
  filter(trt %in% c("DSM"))

fc.lysate <- flow.spore %>%
  filter(trt %in% c("LYSATE"))

fc.spent <- flow.spore %>%
  filter(trt %in% c("SPENT"))
```

Run Gompertz
```{r}
setwd("~/GitHub/danger.signal/1.flow_cytometry/GrowthCurves/bin")
fc.buffer.1 <- growth.modGomp(input = fc.buffer.wide.clean.exp1, output.name = "fc.buffer.exp1.1.parms",
                 synergy = F, temp = F, smooth = T, trim = T)
```
# Error from running Gompertz 
Error in ts(x) : 'ts' object must have one or more observations


```{r}
fc.DSM.1 <- growth.modGomp(input = fc.DSM,output.name = "fc.DSM.1.parms",
                  synergy = F, temp = F, smooth = T, trim = T)
fc.lysate.1  <- growth.modGomp(input = fc.lysate.1, output.name = "fc.lysate.1.parms",
                 synergy = F, temp = F, smooth = T, trim = T)
fc.spent.1 <- growth.modGomp(input = fc.spent.1, output.name = "fc.spent.1.parms",
               synergy = F, temp = F, smooth = T, trim = T)
```

Going rouge for a minute and trying something other than Gompertz for these types of estimations
```{r}
library(gcplyr)

```



